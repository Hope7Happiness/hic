# 复杂Agent集成测试示例说明

## 文件：`complex_integrated_test_cn.py`

这是一个**完整的、真实场景**的Agent集成测试示例，展示了框架在复杂任务中的能力。

## 功能特点

### 🎯 测试场景：数据分析工作流

模拟一个真实的数据分析任务，包含：
1. **数据库查询** - 从模拟数据库获取销售概览
2. **文件读取** - 读取JSON格式的详细数据
3. **数据分析** - 使用Python进行统计计算
4. **报告生成** - 创建中文格式的分析报告
5. **结果验证** - 检查输出文件和内容

### 🔧 使用的工具（5个）

1. **`python_exec`** - 执行Python代码（支持json、os等库）
2. **`file_read`** - 读取文件内容
3. **`file_write`** - 写入文件
4. **`data_query`** - 查询模拟数据库
5. **`calculator`** - 安全的数学计算

### 📊 输出内容（全中文）

**实时显示：**
- 每次迭代的详细信息
- LLM的思考过程（Thought）
- 工具调用和参数
- 工具执行结果
- 解析状态和错误

**执行总结：**
- 总迭代次数
- 执行时间
- 工具使用统计
- 成功率统计
- 最终报告内容

### 🎨 自定义中文回调

实现了 `ChineseVerboseCallback` 类，提供：
- 中文提示和说明
- emoji图标美化
- 结构化输出格式
- 详细的执行追踪

## 运行示例

### 前置条件

```bash
# 确保已安装依赖
pip install openai pydantic pyyaml

# 设置DeepSeek API key（两种方式任选其一）
export DEEPSEEK_API_KEY="your-api-key"
# 或者保存到文件: /home/zhh/看你妈呢
```

### 执行命令

```bash
cd /home/zhh/Documents/Github/hic
python examples/complex_integrated_test_cn.py
```

### 预期输出

```
================================================================================
复杂Agent集成测试 - 数据分析场景
================================================================================

这个测试展示一个真实的数据分析工作流:
  1. 从数据库查询销售数据
  2. 读取数据文件进行分析
  3. 使用Python进行数据处理
  4. 生成分析报告
  5. 保存结果并验证

所有中间步骤将以中文详细展示。

✅ 已创建测试数据文件: /tmp/sales_data_xxx.json
📄 报告将保存到: /tmp/sales_report_xxx.txt

================================================================================
🚀 Agent开始执行
================================================================================
📋 任务: 请完成以下数据分析任务...
🤖 Agent名称: 数据分析助手
🕐 开始时间: 2026-01-25 16:44:01
================================================================================

────────────────────────────────────────────────────────────────────────────────
🔄 第 1 次迭代开始
────────────────────────────────────────────────────────────────────────────────

💬 用户输入到LLM:
   请完成以下数据分析任务...

🧠 LLM响应:
────────────────────────────────────────────────────────────────────────────────
💭 思考: 我将一步步完成这个数据分析任务...
⚡ 动作: tool
🔧 工具: data_query
📦 参数: {"query_type": "summary", "data_source": "sales"}
────────────────────────────────────────────────────────────────────────────────

✅ 成功解析 - 将执行工具: data_query

🔧 调用工具
   工具名称: data_query
   参数:
      query_type: summary
      data_source: sales

📤 工具执行结果
   工具: data_query
   状态: ✅ 成功
   结果:
      {
        "total_sales": 1250000,
        "average_monthly": 104167,
        "top_products": ["智能手机", "笔记本电脑", "平板电脑"],
        "growth_rate": 15.3
      }

✓ 第 1 次迭代完成 (动作类型: tool)

[... 中间省略多次迭代 ...]

────────────────────────────────────────────────────────────────────────────────
🔄 第 12 次迭代开始
────────────────────────────────────────────────────────────────────────────────

🧠 LLM响应:
────────────────────────────────────────────────────────────────────────────────
💭 思考: 现在我将生成完整的分析报告...
⚡ 动作: finish
📝 回复: 已完成所有数据分析任务...
────────────────────────────────────────────────────────────────────────────────

================================================================================
🏁 Agent执行完成
================================================================================
✅ 成功: True
🔄 总迭代次数: 12
⏱️  执行时间: 92.93 秒
🔧 工具调用次数: 12

📝 最终结果:
────────────────────────────────────────────────────────────────────────────────
   已完成所有数据分析任务...
────────────────────────────────────────────────────────────────────────────────

📊 工具使用统计:
   data_query: 1 次
   file_read: 2 次
   calculator: 8 次
   file_write: 1 次

================================================================================
执行指标
================================================================================
⏱️  Execution Time: 92.93s
🔄 Total Iterations: 12
💬 LLM Requests: 17
⚠️  Parse Errors: 3

🔧 Tool Usage:
   data_query: 1 calls (100% success)
   file_read: 2 calls (50% success)
   calculator: 8 calls (88% success)
   file_write: 1 calls (100% success)

================================================================================
结果验证
================================================================================
✅ 报告文件已创建: /tmp/sales_report_xxx.txt

📄 报告内容:
────────────────────────────────────────────────────────────────────────────────
2024年销售数据分析报告

一、销售总览
根据数据库查询结果：
- 2024年总销售额：1,250,000元
- 月均销售额：104,167元
- 同比增长率：15.3%
...
────────────────────────────────────────────────────────────────────────────────

================================================================================
测试总结
================================================================================
任务完成状态: ✅ 成功
迭代次数: 12
工具使用: 12 次

工具调用序列:
  1. [1] data_query
  2. [2] file_read
  3. [3] file_read
  4. [4] calculator
  5. [5] calculator
  ...

✅ 测试完成!
```

## 输出说明

### 执行阶段

1. **初始化阶段**
   - 创建测试数据文件
   - 初始化LLM和工具
   - 显示任务描述

2. **迭代执行阶段**（每次迭代显示）
   - 🔄 迭代编号
   - 💬 LLM收到的输入
   - 🧠 LLM的完整响应
   - 💭 思考过程
   - ⚡ 动作类型
   - 🔧 工具调用（名称+参数）
   - 📤 工具结果
   - ✅ 解析状态

3. **完成阶段**
   - 🏁 执行总结
   - 📊 详细指标
   - ✅ 结果验证
   - 📄 生成的报告内容
   - 🗑️ 清理临时文件

### 指标统计

- **时间统计**：总执行时间
- **迭代统计**：总迭代次数、LLM请求次数
- **工具统计**：每个工具的调用次数和成功率
- **错误统计**：解析错误次数
- **序列展示**：完整的工具调用顺序

## 代码结构

```python
# 1. 工具定义（5个专业工具）
def python_exec(code: str) -> str: ...
def file_read(path: str) -> str: ...
def file_write(path: str, content: str) -> str: ...
def data_query(query_type: str, data_source: str) -> str: ...
def calculator(expression: str) -> str: ...

# 2. 自定义中文回调
class ChineseVerboseCallback(AgentCallback):
    """详细的中文回调，展示完整执行过程"""
    
    def on_agent_start(self, task, agent_name): ...
    def on_iteration_start(self, iteration, agent_name): ...
    def on_llm_request(self, iteration, prompt, system_prompt): ...
    def on_llm_response(self, iteration, response): ...
    def on_tool_call(self, iteration, tool_name, arguments): ...
    def on_tool_result(self, iteration, tool_name, result, success): ...
    def on_agent_finish(self, success, iterations, content): ...

# 3. 主测试流程
def run_complex_integrated_test():
    # 创建测试数据
    # 初始化Agent
    # 执行复杂任务
    # 验证结果
    # 打印统计
```

## 测试数据

### 模拟数据库（data_query）

```python
databases = {
    "sales": {
        "total": "2024年总销售额: ¥1,250,000",
        "monthly": "月平均销售额: ¥104,167",
        "top_product": "最畅销产品: 智能手机 (35%市场份额)",
        "growth": "同比增长率: +15.3%",
        "summary": {详细的JSON数据}
    }
}
```

### 数据文件（JSON）

```json
{
  "products": [
    {"name": "智能手机", "sales": 437500, "units": 2500},
    {"name": "笔记本电脑", "sales": 375000, "units": 750},
    {"name": "平板电脑", "sales": 250000, "units": 1250},
    {"name": "智能手表", "sales": 125000, "units": 1000},
    {"name": "蓝牙耳机", "sales": 62500, "units": 1250}
  ],
  "total_sales": 1250000,
  "period": "2024年1-12月"
}
```

## 生成的报告示例

```
2024年销售数据分析报告

一、销售总览
根据数据库查询结果：
- 2024年总销售额：1,250,000元
- 月均销售额：104,167元
- 同比增长率：15.3%
- 销售额前三产品：智能手机、笔记本电脑、平板电脑

二、详细数据分析
基于详细销售数据文件分析结果：

1. 销售额最高的3个产品：
   第1名：智能手机 - 销售额：437,500元
   第2名：笔记本电脑 - 销售额：375,000元
   第3名：平板电脑 - 销售额：250,000元

2. 平均单价：
   总销售额：1,250,000元
   总销量：6,750件
   平均单价：185.19元/件

3. 各产品销售占比：
   智能手机：35.0%
   笔记本电脑：30.0%
   平板电脑：20.0%
   智能手表：10.0%
   蓝牙耳机：5.0%

三、分析结论
1. 智能手机是公司的核心产品，贡献了35%的销售额
2. 前三名产品合计占比85%，是公司的主要收入来源
3. 产品结构较为合理，形成了明显的主力产品梯队
4. 2024年销售表现良好，实现了15.3%的同比增长
```

## 特点总结

### ✅ 优势

1. **真实场景** - 模拟实际的数据分析工作流
2. **全中文输出** - 所有提示、结果都是中文
3. **详细追踪** - 每个步骤都有详细的日志
4. **多工具协作** - 展示5种不同工具的使用
5. **复杂推理** - 需要多步骤规划和执行
6. **结果验证** - 自动验证生成的报告
7. **性能统计** - 完整的执行指标

### 📈 执行统计（典型值）

- **迭代次数**：10-15次
- **执行时间**：60-120秒（取决于LLM响应速度）
- **工具调用**：10-15次
- **成功率**：85-100%
- **LLM请求**：15-20次

### 🎓 学习价值

通过这个示例，你可以学习：
1. 如何设计复杂的多步骤任务
2. 如何创建自定义的回调系统
3. 如何处理文件I/O和数据分析
4. 如何生成结构化的报告
5. 如何验证Agent的执行结果
6. 如何使用中文进行Agent交互

## 与其他示例的对比

| 特性 | simple_agent.py | complex_agent_verbose.py | **complex_integrated_test_cn.py** |
|------|-----------------|--------------------------|-----------------------------------|
| 语言 | 英文 | 英文 | **中文** |
| 复杂度 | 低 | 中 | **高** |
| 工具数量 | 2-3 | 4 | **5** |
| 实时输出 | 否 | 是 | **是（详细）** |
| 场景真实性 | 演示 | 演示 | **真实业务** |
| 结果验证 | 否 | 部分 | **完整** |
| 自定义回调 | 否 | 是 | **是（中文）** |

## 扩展建议

基于这个示例，你可以：
1. 修改测试数据，模拟不同的业务场景
2. 添加更多工具（如API调用、数据库连接）
3. 实现更复杂的数据分析逻辑
4. 集成真实的数据源
5. 添加错误处理和重试逻辑
6. 实现报告的可视化（图表、表格）
7. 支持多种输出格式（PDF、Excel）

## 常见问题

### Q: 为什么有些工具会失败？
A: LLM可能传递错误的参数或格式，框架会捕获错误并重试。

### Q: 如何减少执行时间？
A: 使用更快的LLM模型或调整max_iterations参数。

### Q: 可以使用其他LLM吗？
A: 可以，只需替换DeepSeekLLM为OpenAILLM或其他实现。

### Q: 如何保存完整日志？
A: 添加FileLoggerCallback到callbacks列表。

## 总结

这个示例展示了框架在复杂真实场景下的能力，包括：
- ✅ 多工具协作
- ✅ 多步骤推理
- ✅ 文件操作
- ✅ 数据分析
- ✅ 报告生成
- ✅ 中文交互
- ✅ 详细追踪
- ✅ 结果验证

是学习和测试框架的最佳参考示例！
